#!/usr/bin/env bash

# so-api-curl: Wrapper script for making authenticated API calls to the SO API
# Usage: so-api-curl [OPTIONS] <endpoint>
# Example: so-api-curl /connect/grid/status

set -euo pipefail

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Load environment variables from .env if it exists
if [[ -f "$SCRIPT_DIR/.env" ]]; then
    set -a
    source "$SCRIPT_DIR/.env"
    set +a
fi

# Configuration
API_BASE_URL="${URL_BASE:-}"
TOKEN_ENDPOINT="/oauth2/token"
CA_CERT_PATH="${CA_CERT:-$SCRIPT_DIR/so-ca.crt}"
TIMEOUT="${TIMEOUT:-10}"
CLIENT_ID="${CLIENT_ID:-}"
CLIENT_SECRET="${CLIENT_SECRET:-}"

# Color output helpers
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check required variables
if [[ -z "$URL_BASE" ]]; then
    echo -e "${RED}Error: URL_BASE environment variable is required${NC}" >&2
    echo "Set it in .env file or export it in your shell" >&2
    exit 1
fi

if [[ -z "$CLIENT_ID" ]] || [[ -z "$CLIENT_SECRET" ]]; then
    echo -e "${RED}Error: CLIENT_ID and CLIENT_SECRET environment variables are required${NC}" >&2
    echo "Set them in .env file or export them in your shell" >&2
    exit 1
fi

# Check if CA cert exists
if [[ ! -f "$CA_CERT_PATH" ]]; then
    echo -e "${YELLOW}Warning: CA certificate not found at $CA_CERT_PATH${NC}" >&2
    echo "API calls may fail due to SSL verification issues" >&2
fi

# Parse command line arguments
METHOD="GET"
ENDPOINT=""
VERBOSE=0
RAW_OUTPUT=0
POST_DATA=""

show_usage() {
    cat <<EOF
Usage: so-api-curl [OPTIONS] <endpoint>

Wrapper script for making authenticated API calls to the SO API.

OPTIONS:
    -X, --request METHOD    HTTP method (default: GET)
    -d, --data DATA        POST data (sets method to POST)
    -v, --verbose          Show verbose output including token info
    -r, --raw              Output raw JSON without formatting
    -h, --help             Show this help message

EXAMPLES:
    so-api-curl /connect/grid/status
    so-api-curl -v /connect/grid
    so-api-curl -X POST /connect/gridmembers/NODE_ID/restart
    so-api-curl -d '{"key":"value"}' /some/endpoint

ENVIRONMENT VARIABLES:
    CLIENT_ID              OAuth2 client ID (required)
    CLIENT_SECRET          OAuth2 client secret (required)
    URL_BASE               API base URL (required)
    CA_CERT                Path to CA certificate (default: ./so-ca.crt)
    TIMEOUT                Request timeout in seconds (default: 10)

EOF
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -X|--request)
            METHOD="$2"
            shift 2
            ;;
        -d|--data)
            POST_DATA="$2"
            METHOD="POST"
            shift 2
            ;;
        -v|--verbose)
            VERBOSE=1
            shift
            ;;
        -r|--raw)
            RAW_OUTPUT=1
            shift
            ;;
        -h|--help)
            show_usage
            exit 0
            ;;
        -*)
            echo -e "${RED}Error: Unknown option $1${NC}" >&2
            show_usage >&2
            exit 1
            ;;
        *)
            ENDPOINT="$1"
            shift
            ;;
    esac
done

# Check if endpoint is provided
if [[ -z "$ENDPOINT" ]]; then
    echo -e "${RED}Error: Endpoint is required${NC}" >&2
    show_usage >&2
    exit 1
fi

# Build full URL
TOKEN_URL="${API_BASE_URL}${TOKEN_ENDPOINT}"
if [[ "$ENDPOINT" == http://* ]] || [[ "$ENDPOINT" == https://* ]]; then
    API_URL="$ENDPOINT"
else
    API_URL="${API_BASE_URL%/}/${ENDPOINT#/}"
fi

# Function to get access token
get_access_token() {
    local response
    local http_code
    local temp_file
    temp_file=$(mktemp)
    
    if [[ "$VERBOSE" -eq 1 ]]; then
        echo -e "${BLUE}Requesting OAuth2 token from: $TOKEN_URL${NC}" >&2
    fi
    
    http_code=$(curl -s -w "%{http_code}" -o "$temp_file" \
        --max-time "$TIMEOUT" \
        --cacert "$CA_CERT_PATH" \
        -u "$CLIENT_ID:$CLIENT_SECRET" \
        -d "grant_type=client_credentials" \
        "$TOKEN_URL")
    
    response=$(cat "$temp_file")
    rm -f "$temp_file"
    
    if [[ "$http_code" -ne 200 ]]; then
        echo -e "${RED}Error: Failed to get access token (HTTP $http_code)${NC}" >&2
        echo "$response" >&2
        return 1
    fi
    
    local access_token
    local expires_in
    access_token=$(echo "$response" | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)
    expires_in=$(echo "$response" | grep -o '"expires_in":[0-9]*' | cut -d':' -f2)
    
    if [[ -z "$access_token" ]]; then
        echo -e "${RED}Error: Could not extract access token from response${NC}" >&2
        echo "$response" >&2
        return 1
    fi
    
    if [[ "$VERBOSE" -eq 1 ]]; then
        echo -e "${GREEN}Token acquired successfully${NC}" >&2
        if [[ -n "$expires_in" ]]; then
            echo -e "${BLUE}Token expires in: ${expires_in}s${NC}" >&2
        fi
    fi
    
    echo "$access_token"
}

# Get access token
ACCESS_TOKEN=$(get_access_token) || exit 1

# Make API request
if [[ "$VERBOSE" -eq 1 ]]; then
    echo -e "${BLUE}Making $METHOD request to: $API_URL${NC}" >&2
fi

CURL_ARGS=(
    -s
    -w "\n%{http_code}"
    --max-time "$TIMEOUT"
    --cacert "$CA_CERT_PATH"
    -H "Authorization: Bearer $ACCESS_TOKEN"
    -X "$METHOD"
)

if [[ -n "$POST_DATA" ]]; then
    CURL_ARGS+=(-H "Content-Type: application/json")
    CURL_ARGS+=(-d "$POST_DATA")
fi

temp_file=$(mktemp)
curl "${CURL_ARGS[@]}" "$API_URL" > "$temp_file"

# Extract HTTP code from last line
HTTP_CODE=$(tail -n 1 "$temp_file")
# Get response body (everything except last line)
RESPONSE=$(head -n -1 "$temp_file")
rm -f "$temp_file"

# Check HTTP status
if [[ "$HTTP_CODE" -ge 200 ]] && [[ "$HTTP_CODE" -lt 300 ]]; then
    if [[ "$VERBOSE" -eq 1 ]]; then
        echo -e "${GREEN}Response (HTTP $HTTP_CODE):${NC}" >&2
    fi
    
    # Format JSON output unless raw is requested
    if [[ "$RAW_OUTPUT" -eq 1 ]] || ! command -v jq &> /dev/null; then
        echo "$RESPONSE"
    else
        echo "$RESPONSE" | jq .
    fi
else
    echo -e "${RED}Error: Request failed (HTTP $HTTP_CODE)${NC}" >&2
    echo "$RESPONSE" >&2
    exit 1
fi
